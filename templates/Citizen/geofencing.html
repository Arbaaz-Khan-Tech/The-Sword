{% extends 'base.html' %}

{% block title %}Geofencing - Citizen Safety App{% endblock %}

{% block content %}
    <div class="flex flex-col md:flex-row gap-4">
        <div class="w-full md:w-1/3">
            <h2 class="text-2xl font-bold mb-4 dark:text-white">Geofencing Settings</h2>
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
                <div class="mb-4">
                    <label for="geofenceName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Geofence Name</label>
                    <input type="text" id="geofenceName" class="w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:text-white dark:border-gray-600">
                </div>
                <div class="mb-4">
                    <label for="geofenceRadius" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Radius (meters)</label>
                    <input type="number" id="geofenceRadius" class="w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:text-white dark:border-gray-600">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Alert Type</label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" class="form-checkbox">
                            <span class="ml-2 text-gray-700 dark:text-gray-300">Enter Area</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="form-checkbox">
                            <span class="ml-2 text-gray-700 dark:text-gray-300">Exit Area</span>
                        </label>
                    </div>
                </div>
                <button id="addGeofence" class="w-full bg-primary text-white py-2 px-4 rounded-md hover:bg-primary-dark transition-colors duration-200">Add Geofence</button>
            </div>
        </div>
        <div class="w-full md:w-2/3">
            <div id="map" class="h-[calc(100vh-6rem)] rounded-lg shadow-md"></div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const map = L.map('map').setView([37.7749, -122.4194], 13);  // Initialize map with San Francisco coordinates.

            function updateMapStyle() {
                const isDarkMode = document.documentElement.classList.contains('dark');
                if (isDarkMode) {
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                        subdomains: 'abcd',
                        maxZoom: 19
                    }).addTo(map);
                } else {
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(map);
                }
            }

            updateMapStyle();  // Update the map with the correct style based on dark mode.

            let currentGeofence = null;
            map.on('click', function(e) {
                const geofenceName = document.getElementById('geofenceName').value;
                const geofenceRadius = parseInt(document.getElementById('geofenceRadius').value);

                if (geofenceName && geofenceRadius) {
                    if (currentGeofence) {
                        map.removeLayer(currentGeofence);
                    }

                    currentGeofence = L.circle(e.latlng, {
                        color: 'red',
                        fillColor: '#f03',
                        fillOpacity: 0.5,
                        radius: geofenceRadius
                    }).addTo(map);

                    currentGeofence.bindPopup(geofenceName).openPopup();
                }
            });

            document.getElementById('addGeofence').addEventListener('click', function() {
                if (currentGeofence) {
                    // Optional: Store geofence info, for example, in a list or database.
                    currentGeofence = null;  // Clear current geofence after adding
                    document.getElementById('geofenceName').value = '';
                    document.getElementById('geofenceRadius').value = '';
                }
            });
        });
    </script>
{% endblock %}
