{% extends "Pbase.html" %}

{% block title %}Crime Heatmap - Police Dashboard{% endblock %}

{% block content %}
    <h2 class="text-2xl font-bold mb-4 dark:text-white">Crime Heatmap</h2>
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 mb-4">
        <div class="flex space-x-4 mb-4">
            <!-- Time Range Dropdown -->
            <select id="timeRange" class="bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white rounded-md px-3 py-2">
                <option value="24h">Last 24 Hours</option>
                <option value="7d">Last 7 Days</option>
                <option value="30d">Last 30 Days</option>
            </select>

            <!-- Crime Type Dropdown -->
            <select id="crimeType" class="bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white rounded-md px-3 py-2">
                <option value="all">All Crimes</option>
                <option value="theft">Theft</option>
                <option value="assault">Assault</option>
                <option value="burglary">Burglary</option>
            </select>
        </div>
    </div>

    <!-- Map Display -->
    <div id="map" class="w-full h-[calc(100vh-12rem)] rounded-lg shadow-md"></div>
{% endblock %}

{% block scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const darkModeToggle = document.getElementById('darkModeToggle');
            
            function updateMainContentMargin() {
                if (sidebar.classList.contains('collapsed')) {
                    mainContent.style.marginLeft = '64px';
                } else {
                    mainContent.style.marginLeft = '250px';
                }
            }

            // Initial margin
            updateMainContentMargin();

            sidebarToggle.addEventListener('click', function() {
                sidebar.classList.toggle('collapsed');
                sidebar.classList.toggle('expanded');
                updateMainContentMargin();
            });

            // Dark mode toggle
            darkModeToggle.addEventListener('click', function() {
                document.documentElement.classList.toggle('dark');
                const isDarkMode = document.documentElement.classList.contains('dark');
                localStorage.setItem('darkMode', isDarkMode);
                darkModeToggle.innerHTML = isDarkMode ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
                updateMapStyle();
            });

            // Check for saved dark mode preference
            if (localStorage.getItem('darkMode') === 'true') {
                document.documentElement.classList.add('dark');
                darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            }

            // Initialize map
            const map = L.map('map').setView([37.7749, -122.4194], 13);

            function updateMapStyle() {
                const isDarkMode = document.documentElement.classList.contains('dark');
                if (isDarkMode) {
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                        subdomains: 'abcd',
                        maxZoom: 19
                    }).addTo(map);
                } else {
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(map);
                }
            }

            updateMapStyle();

            // Sample crime data
            const crimeData = [
                [37.7749, -122.4194, 0.5],
                [37.7694, -122.4862, 0.8],
                [37.8019, -122.4189, 0.3],
                [37.7857, -122.4011, 0.6],
                [37.7879, -122.4074, 0.4]
            ];

            // Add heatmap layer
            const heat = L.heatLayer(crimeData, {radius: 25}).addTo(map);

            // Update heatmap on filter change
            document.getElementById('timeRange').addEventListener('change', updateHeatmap);
            document.getElementById('crimeType').addEventListener('change', updateHeatmap);

            function updateHeatmap() {
                // In a real application, you would fetch new data based on the selected filters
                // For this example, we'll just randomize the intensity
                const newData = crimeData.map(point => [point[0], point[1], Math.random()]);
                heat.setLatLngs(newData);
            }
        });
    </script>
{% endblock %}
